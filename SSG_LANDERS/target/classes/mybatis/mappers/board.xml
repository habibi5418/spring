<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.board">
	
	<select id="findRecent5" resultType="Board">
		select rownum, sub.*
    	FROM (
	    	select * 
		    from board 
		    where delete_yn = 'N' 
		    order by boardid desc
		) sub
		<![CDATA[
		where rownum <= 5
		]]>
	</select>
	
	<select id="getTotalCount" resultType="Board">
		select count(*) totalCount
	    from board 
	    where delete_yn = 'N'
	    <if test="searchText != '' and searchText != null">
	    	<choose>
		    	<when test="searchType == 'title'">
		    		and title like concat(concat('%', #{searchText}), '%')
		    	</when>
		    	<when test="searchType == 'contents'">
		    		and contents like concat(concat('%', #{searchText}), '%')
		    	</when>
		    	<when test="searchType == 'writer_uid'">
		    		and writer_uid like concat(concat('%', #{searchText}), '%')
		    	</when>
	    	</choose>
	    </if>
	</select>

	<select id="getAllBoardPageList" resultType="Board">
		select * 
	    from ( 
	        select rownum nrow, n.* 
	        from ( 
				select * 
				from board 
				where delete_yn = 'N' 
		    	<if test="searchText != '' and searchText != null">
			    	<choose>
				    	<when test="searchType == 'title'">
				    		and title like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'contents'">
				    		and contents like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'writer_uid'">
				    		and writer_uid like concat(concat('%', #{searchText}), '%')
				    	</when>
			    	</choose>
			    </if>
				order by boardid desc 
			) n 
			<![CDATA[
			where rownum <= #{endNo}
			]]>
		) 
		where nrow between #{startNo} and #{endNo}
	</select>
	
	<select id="getAllBoardPageListByViewCount" resultType="Board">
		select * 
	    from ( 
	        select rownum nrow, n.* 
	        from ( 
				select * 
				from board 
				where delete_yn = 'N' 
		    	<if test="searchText != '' and searchText != null">
			    	<choose>
				    	<when test="searchType == 'title'">
				    		and title like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'contents'">
				    		and contents like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'writer_uid'">
				    		and writer_uid like concat(concat('%', #{searchText}), '%')
				    	</when>
			    	</choose>
			    </if>
				order by view_count desc, boardid desc 
			) n 
			<![CDATA[
			where rownum <= #{endNo}
			]]>
		) 
		where nrow between #{startNo} and #{endNo}
	</select>
	
	<update id="increaseViews">
		update board
		set view_count = view_count + 1 
		where boardid = #{boardid}
	</update>
	
	<select id="getAllBoardList" resultType="Board">
		select * 
	    from board 
	    where delete_yn = 'N' 
	    order by boardid desc
	</select>
	
	<select id="getAllBoardListByViewCount" resultType="Board">
		select * 
	    from board 
	    where delete_yn = 'N' 
	    order by view_count desc, boardid desc
	</select>
	
	
	<select id="getBoardByBoardid" resultType="Board">
		SELECT *
	    FROM board
	    WHERE boardid = #{boardid}
	    AND delete_yn = 'N'
	</select>

	<select id="getMoreBoardPageList" resultType="Board">
		select * 
		from ( 
			select rownum nrow, n.* 
			from (
	            select * 
	            from board 
	            where delete_yn = 'N' 
		    	<if test="searchText != '' and searchText != null">
			    	<choose>
				    	<when test="searchType == 'title'">
				    		and title like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'contents'">
				    		and contents like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'writer_uid'">
				    		and writer_uid like concat(concat('%', #{searchText}), '%')
				    	</when>
			    	</choose>
			    </if>
			    <![CDATA[
	            and boardid < #{boardid}
	            order by boardid desc 
	        ) n 
	        where rownum <= #{endNo}
	        ]]>
	    ) 
		where nrow between #{startNo} and #{endNo}
	</select>

	<select id="getMoreBoardPageListByViewCount" resultType="Board">
		select * 
		from ( 
			select rownum nrow, n.* 
			from (
	            select * 
	            from board 
	            where delete_yn = 'N' 
		    	<if test="searchText != '' and searchText != null">
			    	<choose>
				    	<when test="searchType == 'title'">
				    		and title like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'contents'">
				    		and contents like concat(concat('%', #{searchText}), '%')
				    	</when>
				    	<when test="searchType == 'writer_uid'">
				    		and writer_uid like concat(concat('%', #{searchText}), '%')
				    	</when>
			    	</choose>
			    </if>
			    <choose>
				    <when test="view_count == 0">
			    		and view_count = 0 and boardid not in 
						<foreach collection="currentBoards" item="item" index="index" open="(" close=")" separator=",">
							#{item}
						</foreach>	
				    </when>
				    <otherwise>
					    <![CDATA[
			            and view_count <  #{view_count}
	        			]]>
				    </otherwise>
			    </choose>
	            order by view_count desc, boardid desc 
	        ) n 
		    <![CDATA[
	        where rownum <= #{endNo}
	        ]]>
	    ) 
		where nrow between #{startNo} and #{endNo}
	</select>
	
	<insert id="writeBoard">
		insert into board(boardid, title, contents, writer_uid)
    	VALUES (seq_board.nextval, #{title}, #{contents}, #{writer_uid})
	</insert>
	
	<update id="updateBoard">
		update board
		set title = #{title}, contents = #{contents}, mod_date = sysdate
		where boardid = #{boardid}
	</update>
	
	<update id="deleteBoard">
	    update board 
	    set delete_yn = 'Y' 
	    where boardid = #{boardid}
	</update>
	
	<update id="deleteBoards">
		update board 
		set delete_yn = 'Y' 
		where boardid in 
		<foreach collection="deleteBoards" item="item" index="index" open="(" close=")" separator=",">
			#{item}
		</foreach>	
	</update>
	
</mapper>